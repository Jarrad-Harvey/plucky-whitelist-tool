#!/usr/bin/env bash
set -euo pipefail

# -------------------------------------------------
# CONFIG
# -------------------------------------------------
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
JSON_FILE="$SCRIPT_DIR/unlock_data/entries.json"
PLUCK_CMD="pluck"

DEFAULT_DELAY="30m"
DEFAULT_ALLOW="30m"

# Color codes
GREEN="\033[0;32m"
YELLOW="\033[1;33m"
CYAN="\033[0;36m"
NC="\033[0m" # No Color

# -------------------------------------------------
# HELP
# -------------------------------------------------
usage() {
  cat <<EOF
Usage:
  unlock <code> [duration]
  unlock --register <code> (program=<program> | import=<import> | rule=<rule>) [delay=<delay_duration>] [allow=<allow_duration>]
  unlock --list

Examples:
  unlock dev
  unlock spotify 45m
  unlock --register thesis "import:XXX" delay=30m allow=8h
  unlock --register dev import=XXX allow=8h
  unlock --register zoom "program zoom.us" allow=45m
  unlock --register spotify program=spotify
EOF
  exit 1
}

# -------------------------------------------------
# DEPENDENCIES
# -------------------------------------------------
if ! command -v jq >/dev/null; then
  echo "jq is required – install with: brew install jq"
  exit 1
fi

# Ensure data folder and JSON file exist
if [[ ! -d "$(dirname "$JSON_FILE")" ]]; then
  echo "Creating data directory: $(dirname "$JSON_FILE")"
  mkdir -p "$(dirname "$JSON_FILE")"
fi

if [[ ! -f "$JSON_FILE" ]]; then
  echo "Creating new JSON file at $JSON_FILE"
  echo "{}" > "$JSON_FILE"
fi


# -------------------------------------------------
# MODE DETECTION
# -------------------------------------------------
MODE="unlock"
if [[ "${1:-}" == "--register" ]]; then
  MODE="register"
  shift
elif [[ "${1:-}" == "--edit" ]]; then
  MODE="edit"
  shift
elif [[ "${1:-}" == "--list" ]]; then
  MODE="list"
  shift
elif [[ "${1:-}" == "--sync" ]]; then
  MODE="sync"
  shift
fi

# -------------------------------------------------
# LIST MODE
# -------------------------------------------------
if [[ "$MODE" == "list" ]]; then
  echo "Registered unlockable items:"
  jq -r 'to_entries[] | [.key, .value.rule, .value.allow] | @tsv' "$JSON_FILE" | while IFS=$'\t' read -r key rule duration; do
    printf "  ${GREEN}%-15s${NC} → ${YELLOW}%-25s${NC} (default duration: ${CYAN}%s${NC})\n" "$key" "$rule" "$duration"
  done
  exit 0
fi

# -------------------------------------------------
# SYNC MODE
# -------------------------------------------------
if [[ "$MODE" == "sync" ]]; then
  echo "Synchronizing all registered items (re-running pluck delay commands)..."
  
  jq -r 'to_entries[] | [.key, .value.rule, .value.delay] | @tsv' "$JSON_FILE" | while IFS=$'\t' read -r key rule delay; do
    printf "  ${GREEN}%-15s${NC} → ${YELLOW}%-25s${NC} (delay: ${CYAN}%s${NC})\n" "$key" "$rule" "$delay"

    # Only run pluck if delay is set
    if [[ -n "$delay" && "$delay" != "null" ]]; then
      "$PLUCK_CMD" delay "$delay" "$rule"
    else
      echo "    Skipping '$key': delay not set"
    fi
  done
  exit 0
fi


# -------------------------------------------------
# REGISTER / EDIT MODE
# -------------------------------------------------
if [[ "$MODE" == "register" || "$MODE" == "edit" ]]; then
  [[ $# -ge 1 ]] || usage
  KEY="$(echo "$1" | tr '[:upper:]' '[:lower:]')"
  shift

  # Defaults
  DELAY_DURATION="$DEFAULT_DELAY"
  ALLOW_DURATION="$DEFAULT_ALLOW"
  RULE=""

  # When editing, use existing values as defaults
  if [[ "$MODE" == "edit" ]]; then
    EXISTING=$(jq -r ".\"$KEY\"" "$JSON_FILE")
    if [[ "$EXISTING" == "null" ]]; then
      echo "Error: '$KEY' not found."
      exit 1
    fi
    DELAY_DURATION=$(echo "$EXISTING" | jq -r '.delay // "'"$DEFAULT_DELAY"'"')
    ALLOW_DURATION=$(echo "$EXISTING" | jq -r '.allow // "'"$DEFAULT_ALLOW"'"')
    RULE=$(echo "$EXISTING" | jq -r '.rule // ""')
  fi

  # Parse args
  for arg in "$@"; do
    case "$arg" in
      delay=*) DELAY_DURATION="${arg#delay=}" ;;
      allow=*) ALLOW_DURATION="${arg#allow=}" ;;
      program=*) RULE="allow program ${arg#program=}" ;;
      import=*) RULE="import:${arg#import=}" ;;
      rule=*) RULE="${arg#rule=}" ;;
    esac
  done

  if [[ -z "$RULE" ]]; then
    echo "Error: rule not specified. Use program=XXX, import=XXX, or raw rule."
    usage
  fi

  # Update JSON
  TMP_FILE="$(mktemp)"
  jq ". + {\"$KEY\": {\"rule\": \"$RULE\", \"allow\": \"$ALLOW_DURATION\", \"delay\": \"$DELAY_DURATION\"}}" "$JSON_FILE" > "$TMP_FILE"
  mv "$TMP_FILE" "$JSON_FILE"

  echo "Registered '$KEY' with rule '$RULE' (allow_duration=$ALLOW_DURATION, delay_duration=$DELAY_DURATION)"

  # Run initial pluck delay
  echo "Running: $PLUCK_CMD delay $DELAY_DURATION \"$RULE\""
  "$PLUCK_CMD" delay "$DELAY_DURATION" "$RULE"
  exit 0
fi

# -------------------------------------------------
# UNLOCK MODE
# -------------------------------------------------
[[ $# -ge 1 ]] || usage
KEY="$(echo "$1" | tr '[:upper:]' '[:lower:]')"
ALLOW_DURATION="${2:-}"

# Lookup JSON entry
ENTRY=$(jq -r ".\"$KEY\"" "$JSON_FILE")
if [[ "$ENTRY" == "null" ]]; then
  echo "Error: '$KEY' not found in JSON."
  exit 1
fi

RULE=$(echo "$ENTRY" | jq -r '.rule')
DEFAULT_DURATION=$(echo "$ENTRY" | jq -r '.allow')
DURATION="${ALLOW_DURATION:-$DEFAULT_DURATION}"

# Build and execute pluck command
WHEN="when:now+$DURATION"
echo "Unlocking '$KEY' ($RULE) for $DURATION"
echo "$PLUCK_CMD" + "$WHEN" "$RULE"
exec "$PLUCK_CMD" + "$WHEN" "$RULE"